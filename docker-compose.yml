version: "3.8"

name: gas-optimizer

services:
  # ============================================================
  # Anvil - Ethereum Fork Node
  # ============================================================
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: anvil
    entrypoint: []
    command: >
      sh -c '
        if [ "$ENABLE_FORK" = "true" ]; then
          echo "ðŸš€ Starting ANVIL WITH fork...";
          anvil --host 0.0.0.0 --port 8545 \
                --disable-block-gas-limit \
                --fork-url https://eth-mainnet.g.alchemy.com/v2/$ALCHEMY_API_KEY \
                --fork-block-number $ANVIL_FORK_BLOCK \
                --auto-impersonate --chain-id 1 --code-size-limit 4294967295;
        else
          echo "ðŸ”§ Starting ANVIL WITHOUT fork...";
          anvil --host 0.0.0.0 --port 8545 \
                --timestamp "${ANVIL_TIMESTAMP:-0}" \
                --auto-impersonate --chain-id 1 --code-size-limit 4294967295;
        fi
      '
    ports:
      - "8545:8545"
    environment:
      ENABLE_FORK: "${ENABLE_FORK:-false}"
      ALCHEMY_API_KEY: "${ALCHEMY_API_KEY:-}"
      ANVIL_FORK_BLOCK: "${ANVIL_FORK_BLOCK:-0}"
      ANVIL_TIMESTAMP: "${ANVIL_TIMESTAMP:-0}"
    networks:
      - optimizernet

  # ============================================================
  # Compiler - Solidity Compilation Container + Slither
  # ============================================================
  compiler:
    image: trailofbits/eth-security-toolbox:nightly
    container_name: compiler
    working_dir: /share
    entrypoint: /bin/bash
    command: -lc "tail -f /dev/null"
    user: "0:0"
    volumes:
      - ./gas-optimizer-orchestrator/src/main/kotlin/de/orchestrator/gas_optimizer_orchestrator/externalContracts:/share
    networks:
      - optimizernet

  # ============================================================
  # Orchestrator - Spring Boot Application
  # ============================================================
  orchestrator:
    build:
      context: ./gas-optimizer-orchestrator
      dockerfile: Dockerfile
    container_name: orchestrator
    volumes:
      # Mount Docker socket to control sibling containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount docker-compose.yml so we can run compose commands
      - ./docker-compose.yml:/app/docker-compose.yml:ro
      # Shared volume for compiled contracts
      - ./gas-optimizer-orchestrator/src/main/kotlin/de/orchestrator/gas_optimizer_orchestrator/externalContracts:/share
    environment:
      # Web3 / Anvil - use container name for networking
      WEB3_HTTP_URL: http://anvil:8545
      ALCHEMY_API_KEY: ${ALCHEMY_API_KEY}
      ETHERSCAN_API_KEY: ${ETHERSCAN_API_KEY}
      EXTERNAL_CONTRACTS_DIR: /share
      # Docker compose file location inside container
      DOCKER_COMPOSE_FILE: /app/docker-compose.yml
      # Java
      JAVA_OPTS: "-Xmx512m"
    ports:
      - "8080:8080"
    depends_on:
      - anvil
      - compiler
    networks:
      - optimizernet

# ============================================================
# Volumes
# ============================================================
volumes:
  shared-contracts:
    driver: local

# ============================================================
# Networks
# ============================================================
networks:
  optimizernet:
    driver: bridge