package de.orchestrator.gas_optimizer_orchestrator.config

import de.orchestrator.gas_optimizer_orchestrator.docker.DockerComposeAnvilManager
import de.orchestrator.gas_optimizer_orchestrator.service.DeployService
import de.orchestrator.gas_optimizer_orchestrator.externalApi.EtherScanService
import de.orchestrator.gas_optimizer_orchestrator.service.AnvilInteractionService
import de.orchestrator.gas_optimizer_orchestrator.service.SourceCodeParserService
import de.orchestrator.gas_optimizer_orchestrator.service.InteractionCreationService
import org.springframework.boot.CommandLineRunner
import org.springframework.context.annotation.Bean
import org.springframework.context.annotation.Configuration
import org.web3j.abi.FunctionEncoder
import java.nio.file.Path


@Configuration
class DemoDeployConfig(
    private val interactionCreationService: InteractionCreationService,
    private val etherScanService: EtherScanService,
    private val anvilInteractionService: AnvilInteractionService,
    private val dockerComposeAnvilManager: DockerComposeAnvilManager,
    private val deployService: DeployService,
    private val sourceCodeParserService: SourceCodeParserService
) {
    val outDir = Path.of("gas-optimizer-orchestrator/src/main/kotlin/de/orchestrator/gas_optimizer_orchestrator/externalContracts")

    @Bean
    fun demoDeployRunner() = CommandLineRunner {

        val target = "0x5b2646592bb33691DD6D04c001246054D3483c99"

        val transactions = etherScanService.getTransactionsForAddress(target)
        val abi = etherScanService.getContractAbi(target)
        val srcMeta = etherScanService.getContractSourceCode(target, chainId = "1")
        val constructorArgs = srcMeta.constructorArgumentsHex
        println("These are the constructor args: $constructorArgs")
        val files = sourceCodeParserService.materializeSourcesForCrytic(srcMeta, outDir)
        val optimizedBytecode = "0x6080604052xx600555xx600655xx600755xx600855xx600955xx600a55xx600b55xx600c55xx600d55xx600f60156101000a81548160ff021916908315150217905550xx600f60166101000a81548160ff021916908315150217905550xx601055xx60115561271060056009600a60779190610866565b633b9aca00608691906108b0565b609091906108b0565b609a919061091e565b601255601e60125460ac91906108b0565b601355606460026009600a60c19190610866565b633b9aca0060d091906108b0565b60da91906108b0565b60e4919061091e565b601455606460026009600a60f99190610866565b633b9aca0061010891906108b0565b61011291906108b0565b61011c919061091e565b601555xx61012e61059160201b60201c565b905080xxxx6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508073ffffffffffffffffffffffffffffffffffffffff16xx73ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a3506101d861059160201b60201c565b600460016101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060016003xx61022b61059860201b60201c565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx20xx6101000a81548160ff02191690831515021790555060016003xx3073ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx20xx6101000a81548160ff02191690831515021790555060016003xx600460019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx20xx6101000a81548160ff021916908315150217905550606460626009600a6103589190610866565b633b9aca0061036791906108b0565b61037191906108b0565b61037b919061091e565b6001xx3073ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx2081905550606460026009600a6103ce9190610866565b633b9aca006103dd91906108b0565b6103e791906108b0565b6103f1919061091e565b6001xx61040261059160201b60201c565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx20819055503073ffffffffffffffffffffffffffffffffffffffff16xx73ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef606460626009600a6104a09190610866565b633b9aca006104af91906108b0565b6104b991906108b0565b6104c3919061091e565b6040516104d0919061095d565b60405180910390a36104e661059160201b60201c565b73ffffffffffffffffffffffffffffffffffffffff16xx73ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef606460026009600a6105469190610866565b633b9aca0061055591906108b0565b61055f91906108b0565b610569919061091e565b604051610576919061095d565b60405180910390a361058c6105bf60201b60201c565b6109ee565bxx33905090565bxxxxxx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b6105cd61059160201b60201c565b73ffffffffffffffffffffffffffffffffffffffff16xxxx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161461065a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610651906109d0565b60405180910390fd5b6009600a6106689190610866565b633b9aca0061067791906108b0565b6014819055506009600a61068b9190610866565b633b9aca0061069a91906108b0565b6015819055507f947f344d56e1e8c70dc492fb94c4ddddd490c016aab685f5e7e47b2e85cb44cf6009600a6106cf9190610866565b633b9aca006106de91906108b0565b6040516106eb919061095d565b60405180910390a1565b7f4e487b7100000000000000000000000000000000000000000000000000000000xx5260116004526024xxfd5bxx8160011c9050919050565bxxxx8291508390505b600185111561077757808604811115610753576107526106f5565b5b60018516156107625780820291505b808102905061077085610722565b9450610737565b94509492505050565bxx8261078f576001905061084a565b8161079c57xx905061084a565b81600181146107b257600281146107bc576107eb565b600191505061084a565b60ff8411156107ce576107cd6106f5565b5b8360020a9150848211156107e5576107e46106f5565b5b5061084a565b5060208310610133831016604e8410600b84101617156108205782820a90508381111561081b5761081a6106f5565b5b61084a565b61082d848484600161072e565b92509050818404811115610844576108436106f5565b5b81810290505b9392505050565bxx819050919050565bxx60ff82169050919050565bxx61087082610851565b915061087b8361085a565b92506108a87fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8484610780565b905092915050565bxx6108ba82610851565b91506108c583610851565b92508282026108d381610851565b915082820484148315176108ea576108e96106f5565b5b5092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000xx5260126004526024xxfd5bxx61092882610851565b915061093383610851565b925082610943576109426108f1565b5b828204905092915050565b61095781610851565b82525050565bxx602082019050610970xx83018461094e565b92915050565bxx82825260208201905092915050565b7f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572xx82015250565bxx6109ba602083610976565b91506109c582610986565b602082019050919050565bxx602082019050818103xx8301526109e7816109ae565b9050919050565b613202806109fbxx39xxf3fe60806040526004361061010c57xx3560e01c8063715018a61160945780638f9a55c01160635780638f9a55c01461031f57806395d89b4114610349578063a9059cbb14610373578063bf474bed146103af578063dd62ed3e146103d957610113565b8063715018a61461029f578063751039fc146102b55780637d1db4a5146102cb5780638da5cb5b146102f557610113565b806323b872dd1160db57806323b872dd146101d1578063293230b81461020d578063313ce5671461022357806351bc3c851461024d57806370a082311461026357610113565b806306fdde0314610117578063095ea7b3146101415780630faee56f1461017d57806318160ddd146101a757610113565b3661011357005bxxxxfd5b34801561012257xxxxfd5b5061012b610415565b6040516101389190612340565b60405180910390f35b34801561014c57xxxxfd5b50610167600480360381019061016291906123f1565b610452565b6040516101749190612449565b60405180910390f35b34801561018857xxxxfd5b5061019161046f565b60405161019e9190612471565b60405180910390f35b3480156101b257xxxxfd5b506101bb610475565b6040516101c89190612471565b60405180910390f35b3480156101dc57xxxxfd5b506101f760048036038101906101f2919061248a565b610498565b6040516102049190612449565b60405180910390f35b34801561021857xxxxfd5b5061022161056c565b005b34801561022e57xxxxfd5b50610237610e2e565b60405161024491906124f5565b60405180910390f35b34801561025857xxxxfd5b50610261610e36565b005b34801561026e57xxxxfd5b506102896004803603810190610284919061250e565b610ece565b6040516102969190612471565b60405180910390f35b3480156102aa57xxxxfd5b506102b3610f14565b005b3480156102c057xxxxfd5b506102c9611064565b005b3480156102d657xxxxfd5b506102df611194565b6040516102ec9190612471565b60405180910390f35b34801561030057xxxxfd5b5061030961119a565b6040516103169190612548565b60405180910390f35b34801561032a57xxxxfd5b506103336111c1565b6040516103409190612471565b60405180910390f35b34801561035457xxxxfd5b5061035d6111c7565b60405161036a9190612340565b60405180910390f35b34801561037e57xxxxfd5b50610399600480360381019061039491906123f1565b611204565b6040516103a69190612449565b60405180910390f35b3480156103ba57xxxxfd5b506103c3611221565b6040516103d09190612471565b60405180910390f35b3480156103e457xxxxfd5b506103ff60048036038101906103fa9190612561565b611227565b60405161040c9190612471565b60405180910390f35b60606040518060400160405280600b81526020017f436861636861204d617275000000000000000000000000000000000000000000815250905090565bxx61046561045e6112a9565b84846112b0565b6001905092915050565b60135481565bxx6009600a61048491906126fb565b633b9aca006104939190612745565b905090565bxx6104a4848484611473565b610561846104b06112a9565b61055c856040518060600160405280602881526020016131a5602891396002xx8b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx20xx6105136112a9565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx2054611dbb9092919063ffffffff16565b6112b0565b600190509392505050565b6105746112a9565b73ffffffffffffffffffffffffffffffffffffffff16xxxx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610601576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105f8906127d0565b60405180910390fd5b600f60149054906101000a900460ff1615610651576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161064890612838565b60405180910390fd5b737a250d5630b4cf539739df2c5dacb4c659f2488d600exx6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550xx73ffffffffffffffffffffffffffffffffffffffff16600exx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663c45a01556040518163ffffffff1660e01b8152600401602060405180830381865afa158015610726573dxxxx3e3dxxfd5b505050506040513d601f19601f8201168201806040525081019061074a919061286a565b73ffffffffffffffffffffffffffffffffffffffff1663e6a43905600exx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663ad5c46486040518163ffffffff1660e01b8152600401602060405180830381865afa1580156107cf573dxxxx3e3dxxfd5b505050506040513d601f19601f820116820180604052508101906107f3919061286a565b306040518363ffffffff1660e01b8152600401610811929190612895565b602060405180830381865afa15801561082c573dxxxx3e3dxxfd5b505050506040513d601f19601f82011682018060405250810190610850919061286a565b73ffffffffffffffffffffffffffffffffffffffff1603610a4457600exx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663c45a01556040518163ffffffff1660e01b8152600401602060405180830381865afa1580156108d5573dxxxx3e3dxxfd5b505050506040513d601f19601f820116820180604052508101906108f9919061286a565b73ffffffffffffffffffffffffffffffffffffffff1663c9c65396600exx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663ad5c46486040518163ffffffff1660e01b8152600401602060405180830381865afa15801561097e573dxxxx3e3dxxfd5b505050506040513d601f19601f820116820180604052508101906109a2919061286a565b306040518363ffffffff1660e01b81526004016109c0929190612895565b602060405180830381xx875af11580156109dc573dxxxx3e3dxxfd5b505050506040513d601f19601f82011682018060405250810190610a00919061286a565b600fxx6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610c18565b600exx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663c45a01556040518163ffffffff1660e01b8152600401602060405180830381865afa158015610aae573dxxxx3e3dxxfd5b505050506040513d601f19601f82011682018060405250810190610ad2919061286a565b73ffffffffffffffffffffffffffffffffffffffff1663e6a43905600exx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663ad5c46486040518163ffffffff1660e01b8152600401602060405180830381865afa158015610b57573dxxxx3e3dxxfd5b505050506040513d601f19601f82011682018060405250810190610b7b919061286a565b306040518363ffffffff1660e01b8152600401610b99929190612895565b602060405180830381865afa158015610bb4573dxxxx3e3dxxfd5b505050506040513d601f19601f82011682018060405250810190610bd8919061286a565b600fxx6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505b600fxx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663095ea7b3600exx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff167fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6040518363ffffffff1660e01b8152600401610cb59291906128bc565b602060405180830381xx875af1158015610cd1573dxxxx3e3dxxfd5b505050506040513d601f19601f82011682018060405250810190610cf5919061290d565b50610d3e30600exx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff166009600a610d2a91906126fb565b633b9aca00610d399190612745565b6112b0565b600exx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663f305d7194730610d8630610ece565bxxxx610d9061119a565b426040518863ffffffff1660e01b8152600401610db29695949392919061297a565b60606040518083038185885af1158015610dce573dxxxx3e3dxxfd5b50505050506040513d601f19601f82011682018060405250810190610df391906129ed565b5050506001600f60166101000a81548160ff0219169083151502179055506001600f60146101000a81548160ff021916908315150217905550565bxx6009905090565b600460019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16610e776112a9565b73ffffffffffffffffffffffffffffffffffffffff1614610e9657xxxxfd5bxx610ea030610ece565b9050xx811115610eb457610eb381611e1d565b5bxx479050xx811115610eca57610ec981612088565b5b5050565bxx6001xx8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx20549050919050565b610f1c6112a9565b73ffffffffffffffffffffffffffffffffffffffff16xxxx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610fa9576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610fa0906127d0565b60405180910390fd5bxx73ffffffffffffffffffffffffffffffffffffffff16xxxx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a3xxxxxx6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550565b61106c6112a9565b73ffffffffffffffffffffffffffffffffffffffff16xxxx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146110f9576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016110f0906127d0565b60405180910390fd5b6009600a61110791906126fb565b633b9aca006111169190612745565b6014819055506009600a61112a91906126fb565b633b9aca006111399190612745565b6015819055507f947f344d56e1e8c70dc492fb94c4ddddd490c016aab685f5e7e47b2e85cb44cf6009600a61116e91906126fb565b633b9aca0061117d9190612745565b60405161118a9190612471565b60405180910390a1565b60145481565bxxxxxx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b60155481565b60606040518060400160405280600681526020017f4348414348410000000000000000000000000000000000000000000000000000815250905090565bxx6112176112106112a9565b8484611473565b6001905092915050565b60125481565bxx6002xx8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx20xx8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx2054905092915050565bxx33905090565bxx73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff160361131e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161131590612aad565b60405180910390fd5bxx73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361138c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161138390612b3b565b60405180910390fd5b806002xx8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx20xx8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx20819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925836040516114669190612471565b60405180910390a3505050565bxx73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036114e1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016114d890612bc9565b60405180910390fd5bxx73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361154f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161154690612c57565b60405180910390fd5bxx8111611591576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161158890612ce5565b60405180910390fd5bxxxx905061159d61119a565b73ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff161415801561160b57506115db61119a565b73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614155b15611b0b57xx600d5403611659576116566064611648600954600d54101561163557600554611639565b6007545b856120f190919063ffffffff16565b61216890919063ffffffff16565b90505bxx600d54111561168e5761168b606461167d600c54856120f190919063ffffffff16565b61216890919063ffffffff16565b90505b600fxx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff161480156117375750600exx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614155b801561178a57506003xx8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx20xx9054906101000a900460ff16155b15611883576014548211156117d4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016117cb90612d4d565b60405180910390fd5b601554826117e185610ece565b6117eb9190612d6b565b111561182c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161182390612de8565b60405180910390fd5b611869606461185b600954600d5410156118485760055461184c565b6007545b856120f190919063ffffffff16565b61216890919063ffffffff16565b9050600dxx81548092919061187d90612e06565b91905055505b600fxx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614801561190b57503073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1614155b156119505761194d606461193f600a54600d54101561192c57600654611930565b6008545b856120f190919063ffffffff16565b61216890919063ffffffff16565b90505bxx61195a30610ece565b9050600f60159054906101000a900460ff161580156119c55750600fxx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff16145b80156119dd5750600f60169054906101000a900460ff165b80156119ea575060125481115b80156119fa5750600b54600d5410155b15611a9257601154431115611a1157xx6010819055505b600360105410611a56576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611a4d90612e97565b60405180910390fd5b611a73611a6e84611a69846013546121b1565b6121b1565b611e1d565b6010xx815480929190611a8590612e06565b9190505550436011819055505b600fxx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff16148015611afa5750600f60169054906101000a900460ff165b15611b0957611b0847612088565b5b505bxx811115611c0a57611b63816001xx3073ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx20546121c990919063ffffffff16565b6001xx3073ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx20819055503073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051611c019190612471565b60405180910390a35b611c5a826001xx8773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx205461222690919063ffffffff16565b6001xx8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx2081905550611cfd611cb1828461222690919063ffffffff16565b6001xx8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx20546121c990919063ffffffff16565b6001xx8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001xx20819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef611da0848661222690919063ffffffff16565b604051611dad9190612471565b60405180910390a350505050565bxx838311158290611e02576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611df99190612340565b60405180910390fd5b50xx8385611e109190612eb5565b9050809150509392505050565b6001600f60156101000a81548160ff021916908315150217905550xx600267ffffffffffffffff811115611e5457611e53612ee8565b5b604051908082528060200260200182016040528015611e825781602001602082028036833780820191505090505b5090503081xx81518110611e9957611e98612f15565b5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff1681525050600exx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663ad5c46486040518163ffffffff1660e01b8152600401602060405180830381865afa158015611f3d573dxxxx3e3dxxfd5b505050506040513d601f19601f82011682018060405250810190611f61919061286a565b81600181518110611f7557611f74612f15565b5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff1681525050611fdb30600exx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16846112b0565b600exx9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663791ac94783xx8430426040518663ffffffff1660e01b815260040161203d959493929190612ff9565bxx60405180830381xx87803b15801561205457xxxxfd5b505af1158015612066573dxxxx3e3dxxfd5b5050505050xx600f60156101000a81548160ff02191690831515021790555050565b600460019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051xx60405180830381858888f193505050501580156120ed573dxxxx3e3dxxfd5b5050565bxxxx830361210157xx9050612162565bxx828461210e9190612745565b905082848261211d919061307e565b1461215d576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016121549061311e565b60405180910390fd5b809150505b92915050565bxx6121a983836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f00000000000081525061226f565b905092915050565bxx8183116121bf57826121c1565b815b905092915050565bxxxx82846121d79190612d6b565b90508381101561221c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161221390613186565b60405180910390fd5b8091505092915050565bxx61226783836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250611dbb565b905092915050565bxxxx831182906122b5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016122ac9190612340565b60405180910390fd5b50xx83856122c3919061307e565b9050809150509392505050565bxx81519050919050565bxx82825260208201905092915050565b828183xxxx83830152505050565bxx601f19601f8301169050919050565bxx612312826122d0565b61231c81856122da565b935061232c8185602086016122ea565b612335816122f8565b840191505092915050565bxx602082019050818103xx8301526123588184612308565b905092915050565bxxxxfd5bxx73ffffffffffffffffffffffffffffffffffffffff82169050919050565bxx61238d82612364565b9050919050565b61239d81612383565b81146123a757xxxxfd5b50565bxx813590506123b881612394565b92915050565bxx819050919050565b6123d0816123be565b81146123da57xxxxfd5b50565bxx813590506123eb816123c7565b92915050565bxxxx6040838503121561240757612406612360565b5bxx612414858286016123aa565b9250506020612425858286016123dd565b9150509250929050565bxx8115159050919050565b6124438161242f565b82525050565bxx60208201905061245cxx83018461243a565b92915050565b61246b816123be565b82525050565bxx602082019050612484xx830184612462565b92915050565bxxxxxx606084860312156124a1576124a0612360565b5bxx6124ae868287016123aa565b93505060206124bf868287016123aa565b92505060406124d0868287016123dd565b9150509250925092565bxx60ff82169050919050565b6124ef816124da565b82525050565bxx602082019050612508xx8301846124e6565b92915050565bxx6020828403121561252357612522612360565b5bxx612530848285016123aa565b91505092915050565b61254281612383565b82525050565bxx60208201905061255bxx830184612539565b92915050565bxxxx6040838503121561257757612576612360565b5bxx612584858286016123aa565b9250506020612595858286016123aa565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000xx5260116004526024xxfd5bxx8160011c9050919050565bxxxx8291508390505b6001851115612621578086048111156125fd576125fc61259f565b5b600185161561260c5780820291505b808102905061261a856125cc565b94506125e1565b94509492505050565bxx8261263957600190506126f4565b8161264657xx90506126f4565b816001811461265c576002811461266657612695565b60019150506126f4565b60ff8411156126785761267761259f565b5b8360020a91508482111561268f5761268e61259f565b5b506126f4565b5060208310610133831016604e8410600b84101617156126ca5782820a9050838111156126c5576126c461259f565b5b6126f4565b6126d784848460016125d8565b925090508184048111156126ee576126ed61259f565b5b81810290505b9392505050565bxx612705826123be565b9150612710836124da565b925061273d7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff848461262a565b905092915050565bxx61274f826123be565b915061275a836123be565b9250828202612768816123be565b9150828204841483151761277f5761277e61259f565b5b5092915050565b7f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572xx82015250565bxx6127ba6020836122da565b91506127c582612786565b602082019050919050565bxx602082019050818103xx8301526127e7816127ae565b9050919050565b7f74726164696e6720697320616c7265616479206f70656e000000000000000000xx82015250565bxx6128226017836122da565b915061282d826127ee565b602082019050919050565bxx602082019050818103xx83015261284f81612816565b9050919050565bxx8151905061286481612394565b92915050565bxx6020828403121561287f5761287e612360565b5bxx61288c84828501612856565b91505092915050565bxx6040820190506128a8xx830185612539565b6128b56020830184612539565b9392505050565bxx6040820190506128cfxx830185612539565b6128dc6020830184612462565b9392505050565b6128ec8161242f565b81146128f657xxxxfd5b50565bxx81519050612907816128e3565b92915050565bxx6020828403121561292257612921612360565b5bxx61292f848285016128f9565b91505092915050565bxx819050919050565bxx819050919050565bxx61296461295f61295a84612938565b612941565b6123be565b9050919050565b6129748161294a565b82525050565bxx60c08201905061298dxx830189612539565b61299a6020830188612462565b6129a7604083018761296b565b6129b4606083018661296b565b6129c16080830185612539565b6129ce60a0830184612462565b979650505050505050565bxx815190506129e7816123c7565b92915050565bxxxxxx60608486031215612a0457612a03612360565b5bxx612a11868287016129d9565b9350506020612a22868287016129d9565b9250506040612a33868287016129d9565b9150509250925092565b7f45524332303a20617070726f76652066726f6d20746865207a65726f20616464xx8201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565bxx612a976024836122da565b9150612aa282612a3d565b604082019050919050565bxx602082019050818103xx830152612ac481612a8b565b9050919050565b7f45524332303a20617070726f766520746f20746865207a65726f206164647265xx8201527f7373000000000000000000000000000000000000000000000000000000000000602082015250565bxx612b256022836122da565b9150612b3082612acb565b604082019050919050565bxx602082019050818103xx830152612b5281612b19565b9050919050565b7f45524332303a207472616e736665722066726f6d20746865207a65726f206164xx8201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565bxx612bb36025836122da565b9150612bbe82612b59565b604082019050919050565bxx602082019050818103xx830152612be081612ba7565b9050919050565b7f45524332303a207472616e7366657220746f20746865207a65726f2061646472xx8201527f6573730000000000000000000000000000000000000000000000000000000000602082015250565bxx612c416023836122da565b9150612c4c82612be7565b604082019050919050565bxx602082019050818103xx830152612c6e81612c35565b9050919050565b7f5472616e7366657220616d6f756e74206d757374206265206772656174657220xx8201527f7468616e207a65726f0000000000000000000000000000000000000000000000602082015250565bxx612ccf6029836122da565b9150612cda82612c75565b604082019050919050565bxx602082019050818103xx830152612cfc81612cc3565b9050919050565b7f4578636565647320746865205f6d61785478416d6f756e742e00000000000000xx82015250565bxx612d376019836122da565b9150612d4282612d03565b602082019050919050565bxx602082019050818103xx830152612d6481612d2b565b9050919050565bxx612d75826123be565b9150612d80836123be565b9250828201905080821115612d9857612d9761259f565b5b92915050565b7f4578636565647320746865206d617857616c6c657453697a652e000000000000xx82015250565bxx612dd2601a836122da565b9150612ddd82612d9e565b602082019050919050565bxx602082019050818103xx830152612dff81612dc6565b9050919050565bxx612e10826123be565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203612e4257612e4161259f565b5b600182019050919050565b7f4f6e6c7920332073656c6c732070657220626c6f636b21000000000000000000xx82015250565bxx612e816017836122da565b9150612e8c82612e4d565b602082019050919050565bxx602082019050818103xx830152612eae81612e75565b9050919050565bxx612ebf826123be565b9150612eca836123be565b9250828203905081811115612ee257612ee161259f565b5b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000xx5260416004526024xxfd5b7f4e487b7100000000000000000000000000000000000000000000000000000000xx5260326004526024xxfd5bxx81519050919050565bxx82825260208201905092915050565bxx819050602082019050919050565b612f7481612383565b82525050565bxx612f858383612f6b565b60208301905092915050565bxx602082019050919050565bxx612fa782612f42565b612fb18185612f4c565b9350612fbc83612f5c565b80xx5b83811015612fec578151612fd38882612f7a565b9750612fde83612f91565b925050600181019050612fbf565b5085935050505092915050565bxx60a08201905061300cxx830188612462565b613019602083018761296b565b818103604083015261302b8186612f9d565b905061303a6060830185612539565b6130476080830184612462565b9695505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000xx5260126004526024xxfd5bxx613088826123be565b9150613093836123be565b9250826130a3576130a2613051565b5b828204905092915050565b7f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6fxx8201527f7700000000000000000000000000000000000000000000000000000000000000602082015250565bxx6131086021836122da565b9150613113826130ae565b604082019050919050565bxx602082019050818103xx830152613135816130fc565b9050919050565b7f536166654d6174683a206164646974696f6e206f766572666c6f770000000000xx82015250565bxx613170601b836122da565b915061317b8261313c565b602082019050919050565bxx602082019050818103xx83015261319d81613164565b905091905056fe45524332303a207472616e7366657220616d6f756e74206578636565647320616c6c6f77616e6365a2646970667358221220xxxxxxxxxxxxxxxxxx414493017a56d30e1ec31cb50b12742802ed01c701f05264736f6c634300081e0033"
        println(files)
        //val creationTs = etherScanService.getCreationTimestampSeconds(target)
        //println("created timestamp: $creationTs")
       //dockerComposeAnvilManager.startAnvilNoFork(creationTs)
        val bytecodeJson = Path.of("C:\\Users\\laskevic\\IdeaProjects\\gas-optimizer-orchestrator\\gas-optimizer-orchestrator\\src\\main\\kotlin\\de\\orchestrator\\gas_optimizer_orchestrator\\externalContracts\\crytic-export\\Token.json").toFile()
        //deployService.deployContractFromJson(bytecodeJson,constructorArgs)
        //deployService.deployOptimizedRuntime(optimizedBytecode)
/*
        val receiptUnopt = deployService.deployRawBytecode(bytecode)

        val receiptOpt = deployService.deployRawBytecode(optimizedBytecode)

        println(
            """
                Contract   : ${receiptUnopt.contractAddress}
                TxHash     : ${receiptUnopt.transactionHash}
                GasUsed    : ${receiptUnopt.gasUsed}
                Status     : ${receiptUnopt.status}
                Blocknumber: ${receiptUnopt.blockNumber}
            """.trimIndent()
        )
*/
        /*println(
            """
                Function   : ${receiptOpt.contractAddress}
                TxHash     : ${receiptOpt.transactionHash}
                GasUsed    : ${receiptOpt.gasUsed}
                Status     : ${receiptOpt.status}
                Blocknumber: ${receiptOpt.blockNumber}
            """.trimIndent()
        )*/



        println("First Transaction:  ${transactions[0]}")
        println("This is the abi:  $abi")

        val interactions = interactionCreationService.buildInteractions(
            abiJson = abi,
            contractAddress = target,
            transactions = transactions
        )

        println("All Interactions: $interactions")

        interactions.forEach { i ->
            val f = i.toWeb3jFunction()
            val encoded = FunctionEncoder.encode(f)
            println("Call: ${i.functionName} -> $encoded")
        }
        println("Found ${interactions.size} payable interactions")



        interactions.forEach { interaction ->


            println("Spinning up fork for block ${interaction.blockNumber}")
            //Sometimes requires the exact block and sometimes the previous --> implement Service that does both
            dockerComposeAnvilManager.withAnvilFork(interaction.blockNumber.toLong()-1) {
                dockerComposeAnvilManager.replaceRuntimeBytecode(interaction.contractAddress,optimizedBytecode)
                val result = anvilInteractionService.sendInteraction(interaction)

                println(
                    """
                Function   : ${interaction.functionName}
                TxHash     : ${result.transactionHash}
                GasUsed    : ${result.gasUsed}
                Status     : ${result.status}
                Blocknumber: ${result.blockNumber}
            """.trimIndent()
                )
            }
        }
    }
}